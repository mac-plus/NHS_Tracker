
<!DOCTYPE html>
<html>
<head>
  <title>Hospital Recommender with Postcode</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>Emergency Hospital Recommender (NHS Wales - PoC)</h2>
  <label for="postcode">Enter Your Postcode:</label>
  <input type="text" id="postcode" placeholder="e.g. CF23 9AB" />

  <label for="symptom">Select Symptom for George (Age 3):</label>
  <select id="symptom">
    <option value="Fever under 5">Fever under 5</option><option value="Head injury">Head injury</option><option value="Difficulty breathing">Difficulty breathing</option><option value="Rash with fever">Rash with fever</option><option value="Cut needing stitches">Cut needing stitches</option><option value="Broken bone">Broken bone</option><option value="Diarrhoea and vomiting">Diarrhoea and vomiting</option><option value="High-pitched crying">High-pitched crying</option><option value="Seizure/fitting">Seizure/fitting</option><option value="Swallowed object">Swallowed object</option>
  </select>
  <button onclick="geocodeAndRecommend()">Get Recommendation</button>

  <div class="result" id="result">Awaiting input...</div>

  <script>
    let hospitals = [];
    const symptoms = [{"symptom": "Fever under 5", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 5, "severity": "medium"}, {"symptom": "Head injury", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 16, "severity": "high"}, {"symptom": "Difficulty breathing", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 16, "severity": "high"}, {"symptom": "Rash with fever", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 16, "severity": "high"}, {"symptom": "Cut needing stitches", "priority_services": ["MIU", "A&E"], "min_age": 3, "max_age": 16, "severity": "medium"}, {"symptom": "Broken bone", "priority_services": ["MIU", "A&E"], "min_age": 2, "max_age": 16, "severity": "medium"}, {"symptom": "Diarrhoea and vomiting", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 16, "severity": "medium"}, {"symptom": "High-pitched crying", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 3, "severity": "high"}, {"symptom": "Seizure/fitting", "priority_services": ["A&E", "Paediatrics"], "min_age": 0, "max_age": 16, "severity": "high"}, {"symptom": "Swallowed object", "priority_services": ["A&E", "Paediatrics"], "min_age": 1, "max_age": 10, "severity": "high"}];
    const API_KEY = "YOUR-OPENCAGE-API-KEY";

    const hospitalCoordinates = {
      "Cardiff Royal Infirmary": [51.4857, -3.1658],
      "Royal Glamorgan Hospital": [51.5621, -3.3976],
      "Ysbyty Ystrad Fawr": [51.6502, -3.2387],
      "Princess of Wales Hospital": [51.5077, -3.5836]
    };

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    
async function geocodeAndRecommend() {
  const postcode = document.getElementById("postcode").value;
  const selectedSymptom = document.getElementById("symptom").value;
  if (!postcode || !selectedSymptom) {
    document.getElementById("result").innerHTML = "Please enter a postcode and select a symptom.";
    return;
  }

  try {
    // Fetch hospitals from live API
    const res = await fetch("https://nhs-tracker.onrender.com/hospitals");
    const data = await res.json();
    hospitals = data.hospitals || [];
  } catch (err) {
    document.getElementById("result").innerHTML = "Could not fetch hospital data.";
    return;
  }

      const postcode = document.getElementById("postcode").value;
      const selectedSymptom = document.getElementById("symptom").value;
      if (!postcode || !selectedSymptom) {
        document.getElementById("result").innerHTML = "Please enter a postcode and select a symptom.";
        return;
      }

      fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(postcode)}&key=${API_KEY}`)
        .then(res => res.json())
        .then(data => {
          if (!data.results.length) {
            document.getElementById("result").innerHTML = "Postcode not found.";
            return;
          }
          const userLoc = data.results[0].geometry;
          recommend(selectedSymptom, userLoc);
        })
        .catch(err => {
          document.getElementById("result").innerHTML = "Error fetching location.";
        });
    }

    function recommend(symptom, userLoc) {
      const symptomEntry = symptoms.find(s => s.symptom === symptom);
      if (!symptomEntry) {
        document.getElementById("result").innerHTML = "Symptom not found.";
        return;
      }
      const priorityServices = symptomEntry.priority_services;

      
    if (!hospitals.length) {
      document.getElementById("result").innerHTML = "No hospital data loaded.";
      return;
    }
    const scored = hospitals.map(h => {

        const coords = hospitalCoordinates[h.name];
        const dist = haversineDistance(userLoc.lat, userLoc.lng, coords[0], coords[1]);
        let score = 0;
        if (!priorityServices.some(s => h.services.includes(s))) score += 100;
        if (priorityServices.includes("Paediatrics") && !h.paediatric) score += 50;
        if (!h.open_24_7) score += 20;
        score += h.current_patients * 0.5;
        score += h.wait_minutes * 0.3;
        score += dist * 1.2;
        return {
          name: h.name,
          score: score.toFixed(2),
          wait: h.wait_minutes,
          dist: dist.toFixed(2),
          pts: h.current_patients,
          paeds: h.paediatric,
          open: h.open_24_7
        };
      });

      const ranked = scored.sort((a, b) => parseFloat(a.score) - parseFloat(b.score)).slice(0, 3);

      const output = ranked.map(h => `
        <b>${h.name}</b><br>
        Score: ${h.score} | Distance: ${h.dist} km | Wait: ${h.wait} min | Patients: ${h.pts}<br>
        Paediatrics: ${h.paeds ? '✅' : '❌'} | Open 24/7: ${h.open ? '✅' : '❌'}
        <hr>
      `).join('');

      document.getElementById("result").innerHTML = output;
    }
  </script>
</body>
</html>
